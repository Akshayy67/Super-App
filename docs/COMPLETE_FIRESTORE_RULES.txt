// Complete Firestore Rules - Copy this ENTIRE file to Firebase Console
// Includes: Video Meetings, WebRTC Signaling, Team Quizzes, Community Quizzes, User Profiles, Blocked Users

rules_version = '2';

service cloud.firestore {

  match /databases/{database}/documents {

    

    // Helper function to check if user is authenticated

    function isAuthenticated() {

      return request.auth != null;

    }

    

    // Helper function to check if user is admin (for community quizzes)

    function isAdmin() {

      return request.auth != null && 

        (request.auth.token.email == 'akshayjuluri6704@gmail.com' ||

         request.auth.token.email == '22311a05l5@cse.sreenidhi.edu.in');

    }

    

    // ==================== VIDEO MEETINGS ====================

    

    match /videoMeetings/{meetingId} {

      // Allow creating a meeting if authenticated

      allow create: if request.auth != null

                    && request.resource.data.hostId == request.auth.uid

                    && request.resource.data.status == 'waiting';

      

      // Allow reading if user is authenticated

      allow read: if request.auth != null;

      

      // Allow updating if user is a participant

      allow update: if request.auth != null

                    && (

                      // Host can update anything

                      resource.data.hostId == request.auth.uid

                      // Participants can update their own data

                      || request.auth.uid in resource.data.participants.keys()

                    );

      

      // Only host can delete

      allow delete: if request.auth != null

                    && resource.data.hostId == request.auth.uid;

    }

    

    // ==================== WEBRTC SIGNALING ====================

    

    // WebRTC Signaling Collection (REQUIRED for peer-to-peer video/audio)

    match /webrtcSignaling/{signalId} {

      // Allow creating if authenticated (sending signals)

      allow create: if request.auth != null

                    && request.resource.data.senderId == request.auth.uid;

      

      // Allow reading if the signal is directed to you

      allow read: if request.auth != null

                  && resource.data.recipientId == request.auth.uid;

      

      // Allow deleting if you're the recipient (after processing)

      allow delete: if request.auth != null

                    && resource.data.recipientId == request.auth.uid;

    }

    

    // ==================== TEAM QUIZZES ====================

    

    // Team quizzes collection

    match /team_quizzes/{quizId} {

      // Allow read if user is authenticated and is a member of the team or created the quiz

      allow read: if isAuthenticated() && 

        (resource.data.participants.hasAny([request.auth.uid]) ||

         resource.data.createdBy == request.auth.uid ||

         request.auth.uid in resource.data.participants);

      

      // Allow create if user is authenticated

      allow create: if isAuthenticated() && 

        request.resource.data.createdBy == request.auth.uid;

      

      // Allow update if user is the creator

      allow update: if isAuthenticated() && 

        resource.data.createdBy == request.auth.uid &&

        request.resource.data.createdBy == resource.data.createdBy;

      

      // Allow delete if user is the creator

      allow delete: if isAuthenticated() && 

        resource.data.createdBy == request.auth.uid;

    }

    

    // Team quiz attempts collection

    match /team_quiz_attempts/{attemptId} {

      // Allow read if user is the owner of the attempt or creator of the quiz

      allow read: if isAuthenticated() && 

        (resource.data.userId == request.auth.uid ||

         exists(/databases/$(database)/documents/team_quizzes/$(resource.data.quizId)) &&

         get(/databases/$(database)/documents/team_quizzes/$(resource.data.quizId)).data.createdBy == request.auth.uid);

      

      // Allow create if user is authenticated

      allow create: if isAuthenticated() && 

        request.resource.data.userId == request.auth.uid;

      

      // Allow update if user is the owner of the attempt

      allow update: if isAuthenticated() && 

        resource.data.userId == request.auth.uid &&

        request.resource.data.userId == resource.data.userId;

      

      // Allow delete only by the creator of the quiz or admin

      allow delete: if isAuthenticated() && (

        (exists(/databases/$(database)/documents/team_quizzes/$(resource.data.quizId)) &&

         get(/databases/$(database)/documents/team_quizzes/$(resource.data.quizId)).data.createdBy == request.auth.uid) ||

        isAdmin()

      );

    }

    

    // ==================== COMMUNITY QUIZZES ====================

    

    // Community quizzes collection

    match /community_quizzes/{quizId} {

      // Allow read if user is authenticated

      allow read: if isAuthenticated();

      

      // Allow create only if user is admin

      allow create: if isAuthenticated() && isAdmin() &&

        request.resource.data.createdBy == request.auth.uid;

      

      // Allow update only if user is admin and creator

      allow update: if isAuthenticated() && isAdmin() &&

        resource.data.createdBy == request.auth.uid &&

        request.resource.data.createdBy == resource.data.createdBy;

      

      // Allow delete only if user is admin and creator

      allow delete: if isAuthenticated() && isAdmin() &&

        resource.data.createdBy == request.auth.uid;

    }

    

    // Community quiz attempts collection

    match /community_quiz_attempts/{attemptId} {

      // Allow read if user is the owner of the attempt or admin

      allow read: if isAuthenticated() && 

        (resource.data.userId == request.auth.uid || isAdmin());

      

      // Allow create if user is authenticated

      allow create: if isAuthenticated() && 

        request.resource.data.userId == request.auth.uid;

      

      // Allow update if user is the owner of the attempt

      allow update: if isAuthenticated() && 

        resource.data.userId == request.auth.uid &&

        request.resource.data.userId == resource.data.userId;

      

      // Allow delete only by admin

      allow delete: if isAuthenticated() && isAdmin();

    }

    

    // ==================== USER PROFILES ====================

    

    // User profiles collection

    match /profiles/{profileId} {

      // Allow read access to anyone (for public profile viewing)

      allow read: if true;

      

      // Allow create if user is authenticated and creating their own profile

      allow create: if isAuthenticated() && 

        request.resource.data.userId == request.auth.uid;

      

      // Allow update if user is updating their own profile

      allow update: if isAuthenticated() && 

        resource.data.userId == request.auth.uid &&

        request.resource.data.userId == resource.data.userId;

      

      // Allow delete if user is deleting their own profile

      allow delete: if isAuthenticated() && 

        resource.data.userId == request.auth.uid;

    }

    // ==================== BLOCKED USERS ====================
    
    // Blocked users collection (admin only)
    match /blocked_users/{userId} {
      // Allow read if authenticated (for checking if user is blocked)
      allow read: if isAuthenticated();
      
      // Allow create/update/delete only by admin
      allow create, update, delete: if isAuthenticated() && isAdmin();
    }

    // ==================== OTHER COLLECTIONS ====================

    

    // All other documents - maintain your existing open access

    // This catches everything that doesn't match the specific rules above

    match /{document=**} {

      allow read, write: if request.auth != null;

    }

  }

}
