<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meeting Join Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .log {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>Meeting Join Test</h1>
    
    <div class="test-section">
        <h2>Test Meeting Join Flow</h2>
        <p>This test simulates the meeting join process to verify the fix.</p>
        
        <div>
            <input type="text" id="meetingId" placeholder="Meeting ID" value="test-meeting-123">
            <input type="text" id="userName" placeholder="Your Name" value="Test User">
            <button onclick="testJoinMeeting()">Join Meeting</button>
            <button onclick="testCreateMeeting()">Create Meeting</button>
            <button onclick="clearLog()">Clear Log</button>
        </div>
        
        <h3>Console Log:</h3>
        <div id="log" class="log"></div>
    </div>

    <script>
        let logElement = document.getElementById('log');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            logElement.textContent = '';
        }
        
        // Mock the services for testing
        class MockSignalingService {
            constructor() {
                this.listeners = [];
                this.meetingParticipants = new Map();
                log('🔧 Mock SignalingService initialized');
            }
            
            addEventListener(listener) {
                this.listeners.push(listener);
                return () => {
                    const index = this.listeners.indexOf(listener);
                    if (index > -1) this.listeners.splice(index, 1);
                };
            }
            
            sendMessage(message) {
                log(`📤 Sending message: ${message.type} for meeting ${message.meetingId}`);
                
                // Simulate server response for join-meeting
                if (message.type === 'join-meeting') {
                    this.handleJoinMeeting(message);
                }
            }
            
            handleJoinMeeting(message) {
                const { meetingId, fromParticipant, data } = message;
                
                log(`🔄 Processing join-meeting request from ${data?.participantName || fromParticipant}`);
                
                // Get existing participants
                if (!this.meetingParticipants.has(meetingId)) {
                    this.meetingParticipants.set(meetingId, new Set());
                }
                
                const participants = this.meetingParticipants.get(meetingId);
                const existingParticipants = Array.from(participants).map(participantId => ({
                    participantId,
                    participantName: participantId
                }));
                
                log(`📋 Found ${existingParticipants.length} existing participants`);
                
                // Add new participant
                participants.add(fromParticipant);
                
                // Send response
                setTimeout(() => {
                    const responseMessage = {
                        type: 'meeting-participants',
                        meetingId,
                        fromParticipant: 'server',
                        toParticipant: fromParticipant,
                        data: { participants: existingParticipants },
                        timestamp: new Date()
                    };
                    
                    log(`📨 Sending meeting-participants response with ${existingParticipants.length} participants`);
                    this.notifyListeners(responseMessage);
                }, 100);
            }
            
            notifyListeners(message) {
                this.listeners.forEach(listener => {
                    try {
                        listener(message);
                    } catch (error) {
                        log(`❌ Error in listener: ${error.message}`);
                    }
                });
            }
        }
        
        class MockWebRTCService {
            constructor() {
                this.meetings = new Map();
                this.currentMeeting = null;
                this.signalingService = new MockSignalingService();
                this.signalingService.addEventListener(this.handleSignalingMessage.bind(this));
                log('🔧 Mock WebRTCService initialized');
            }
            
            async joinMeeting(meetingId) {
                const user = { id: 'user-' + Date.now(), name: document.getElementById('userName').value };
                
                log(`🔄 Attempting to join meeting: ${meetingId}`);
                
                const meeting = {
                    id: meetingId,
                    title: `Meeting ${meetingId}`,
                    hostId: 'unknown',
                    participants: new Map(),
                    isActive: true,
                    createdAt: new Date()
                };
                
                const participant = {
                    id: user.id,
                    name: user.name,
                    isHost: false, // Never assume host status when joining
                    isMuted: false,
                    isCameraOn: false,
                    isScreenSharing: false
                };
                
                meeting.participants.set(user.id, participant);
                this.meetings.set(meetingId, meeting);
                this.currentMeeting = meeting;
                
                log(`📤 Sending join-meeting request for: ${participant.name}`);
                
                this.signalingService.sendMessage({
                    type: 'join-meeting',
                    meetingId,
                    fromParticipant: user.id,
                    data: {
                        participantId: user.id,
                        participantName: participant.name,
                        isHost: false
                    }
                });
                
                return meeting;
            }
            
            async createMeeting(title) {
                const user = { id: 'user-' + Date.now(), name: document.getElementById('userName').value };
                const meetingId = 'meeting-' + Date.now();
                
                log(`🆕 Creating new meeting: ${title}`);
                
                const meeting = {
                    id: meetingId,
                    title,
                    hostId: user.id,
                    participants: new Map(),
                    isActive: true,
                    createdAt: new Date()
                };
                
                const participant = {
                    id: user.id,
                    name: user.name,
                    isHost: true, // Creator is always host
                    isMuted: false,
                    isCameraOn: false,
                    isScreenSharing: false
                };
                
                meeting.participants.set(user.id, participant);
                this.meetings.set(meetingId, meeting);
                this.currentMeeting = meeting;
                
                log(`👑 Created meeting ${meetingId} with ${user.name} as host`);
                
                return meeting;
            }
            
            handleSignalingMessage(message) {
                const { type, data } = message;
                
                log(`🔄 Handling signaling message: ${type}`);
                
                if (type === 'meeting-participants') {
                    this.handleMeetingParticipants(data);
                }
            }
            
            handleMeetingParticipants(data) {
                const { participants } = data;
                
                if (!this.currentMeeting || !participants) return;
                
                log(`📋 Received existing participants: ${participants.length}`);
                
                const currentUser = { id: this.currentMeeting.participants.keys().next().value };
                
                if (participants.length > 0) {
                    const currentParticipant = this.currentMeeting.participants.get(currentUser.id);
                    if (currentParticipant) {
                        currentParticipant.isHost = false;
                        log('👤 Current user is joining existing meeting (not host)');
                    }
                } else {
                    const currentParticipant = this.currentMeeting.participants.get(currentUser.id);
                    if (currentParticipant) {
                        currentParticipant.isHost = true;
                        this.currentMeeting.hostId = currentUser.id;
                        log('👑 Current user is the first participant (becomes host)');
                    }
                }
                
                // Log final state
                const currentParticipant = this.currentMeeting.participants.get(currentUser.id);
                log(`✅ Final state: ${currentParticipant?.name} is ${currentParticipant?.isHost ? 'HOST' : 'PARTICIPANT'}`);
            }
        }
        
        const webrtcService = new MockWebRTCService();
        
        async function testJoinMeeting() {
            const meetingId = document.getElementById('meetingId').value;
            if (!meetingId) {
                log('❌ Please enter a meeting ID');
                return;
            }
            
            log(`\n=== TESTING JOIN MEETING ===`);
            try {
                const meeting = await webrtcService.joinMeeting(meetingId);
                log(`✅ Successfully joined meeting: ${meeting.id}`);
            } catch (error) {
                log(`❌ Failed to join meeting: ${error.message}`);
            }
        }
        
        async function testCreateMeeting() {
            const userName = document.getElementById('userName').value;
            const title = `${userName}'s Meeting`;
            
            log(`\n=== TESTING CREATE MEETING ===`);
            try {
                const meeting = await webrtcService.createMeeting(title);
                log(`✅ Successfully created meeting: ${meeting.id}`);
                document.getElementById('meetingId').value = meeting.id;
            } catch (error) {
                log(`❌ Failed to create meeting: ${error.message}`);
            }
        }
        
        log('🚀 Test page loaded. Ready to test meeting join functionality!');
    </script>
</body>
</html>
